<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The Goblin Coin Flipper</title>
  <style>
    :root{
      --goblin-green:#2d5a27;
      --goblin-green-2:#3e7a35;
      --goblin-red:#8b1b17;
      --goblin-gold:#d7b46a;
      --parchment:#f3ead7;
      --ink:#1c1b1a;
      --shadow: 0 10px 18px rgba(0,0,0,.18), 0 2px 6px rgba(0,0,0,.2);
      --radius: 18px;
    }

    /* Global reset & typography */
    *, *::before, *::after{ box-sizing: border-box; }
    html, body { height: 100%; }
    body{
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--ink);
      background:
        radial-gradient(circle at 10% 10%, rgba(255,255,255,.45), transparent 40%),
        radial-gradient(circle at 90% 30%, rgba(255,255,255,.25), transparent 40%),
        linear-gradient(145deg, #efe1c8, #ead9bd 35%, #e1d0ad 70%, #dcc79f);
      min-height: 100dvh;
    }

    .app{
      max-width: 1100px;
      margin: 0 auto;
      padding: 20px clamp(16px, 3vw, 28px) 60px;
      display: grid;
      grid-template-rows: auto auto auto 1fr; /* +dev tests */
      gap: 22px;
    }

    header{
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .brand{
      display: inline-flex;
      align-items: center;
      gap: 12px;
      padding: 10px 14px;
      border-radius: var(--radius);
      background: linear-gradient(135deg, var(--goblin-green), var(--goblin-green-2));
      color: white;
      box-shadow: var(--shadow);
    }

    .brand h1{
      font-size: clamp(20px, 4vw, 34px);
      line-height: 1.1;
      margin: 0;
      letter-spacing: .5px;
      text-shadow: 0 1px 0 rgba(0,0,0,.35);
    }

    .goblin-icon{
      width: clamp(36px, 6vw, 54px);
      height: auto;
      filter: drop-shadow(0 2px 1px rgba(0,0,0,.35));
    }

    .controls{
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 12px;
      align-items: end;
      background: 
        linear-gradient(180deg, rgba(255,255,255,.6), rgba(255,255,255,.25)),
        repeating-linear-gradient(45deg, rgba(215,180,106,.16), rgba(215,180,106,.16) 10px, rgba(215,180,106,.08) 10px, rgba(215,180,106,.08) 20px);
      padding: clamp(10px, 2.5vw, 18px);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      border: 2px solid rgba(0,0,0,.08);
    }

    .field{
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
    }

    label{
      font-weight: 700;
      font-size: clamp(14px, 2.3vw, 16px);
    }

    input[type="number"]{
      width: 100%;
      font-size: clamp(16px, 3vw, 18px);
      padding: 12px 14px;
      border-radius: 12px;
      border: 2px solid rgba(0,0,0,.12);
      background: white;
      outline: none;
      box-shadow: inset 0 1px 0 rgba(0,0,0,.08);
    }
    input[type="number"]:focus{
      border-color: var(--goblin-green-2);
      box-shadow: 0 0 0 4px rgba(62,122,53,.15);
    }

    .btn{
      appearance: none;
      border: none;
      background: linear-gradient(135deg, var(--goblin-red), #a32a25 60%);
      color: #fff;
      font-weight: 800;
      font-size: clamp(16px, 3.5vw, 18px);
      padding: 14px 20px;
      border-radius: 14px;
      cursor: pointer;
      box-shadow: var(--shadow);
      transform: translateZ(0);
      transition: transform .08s ease, filter .2s ease, opacity .2s ease;
    }
    .btn:hover{ transform: translateY(-1px); filter: brightness(1.02); }
    .btn:active{ transform: translateY(1px) scale(.99); }
    .btn[disabled]{ opacity: .6; cursor: not-allowed; }

    .players{
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 14px;
    }

    .card{
      position: relative;
      background: linear-gradient(180deg, rgba(255,255,255,.7), rgba(255,255,255,.4)),
                  radial-gradient(circle at 60% -40%, rgba(141,197,123,.25), transparent 60%);
      border: 2px solid rgba(0,0,0,.08);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow);
      min-height: 120px;
      display: grid;
      grid-template-rows: auto 1fr;
      gap: 8px;
    }

    .card h2{
      margin: 0;
      font-size: clamp(16px, 2.8vw, 20px);
      letter-spacing: .3px;
      color: var(--goblin-green);
      text-shadow: 0 1px 0 rgba(255,255,255,.65);
    }

    .results{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      align-items: center;
    }

    .pill{
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 999px;
      font-weight: 800;
      justify-self: start;
      background: linear-gradient(180deg, rgba(255,255,255,.9), rgba(255,255,255,.75));
      border: 2px solid rgba(0,0,0,.08);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.8);
    }

    .pill .dot{ width: 12px; height: 12px; border-radius: 50%; display: inline-block; }
    .pill.heads .dot{ background: var(--goblin-gold); box-shadow: 0 0 0 2px rgba(215,180,106,.6); }
    .pill.tails .dot{ background: #5a6a7a; box-shadow: 0 0 0 2px rgba(90,106,122,.4); }

    .meta{
      font-size: 12px; opacity: .7; margin-top: 2px;
    }

    /* Overlay coin animation */
    .overlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.35);
      display: grid;
      place-items: center;
      padding: 20px;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity .25s ease;
    }
    .overlay.show{ opacity: 1; pointer-events: auto; }

    .coin-wrap{ display:grid; place-items:center; gap: 16px; }

    .coin{
      width: clamp(96px, 20vw, 150px);
      height: clamp(96px, 20vw, 150px);
      border-radius: 50%;
      position: relative;
      transform-style: preserve-3d;
      animation: flip 900ms linear infinite;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }

    .coin::before{ /* coin rim */
      content: "";
      position: absolute; inset: 0;
      border-radius: 50%;
      padding: 6px; /* rim thickness */
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.7), transparent 50%),
        radial-gradient(circle at 70% 70%, rgba(0,0,0,.18), transparent 60%),
        linear-gradient(135deg, #e8d7a9, #d7b46a);
      -webkit-mask: 
        radial-gradient(farthest-side, #000 98%, #0000) content-box,
        radial-gradient(farthest-side, #000 100%, #0000);
      mask: 
        radial-gradient(farthest-side, #000 98%, #0000) content-box,
        radial-gradient(farthest-side, #000 100%, #0000);
      box-shadow: inset 0 0 8px rgba(0,0,0,.25);
    }

    .face{
      position: absolute; inset: 6px; /* match padding above */
      border-radius: 50%;
      display: grid; place-items: center;
      font-weight: 900; font-size: clamp(24px, 6vw, 40px);
      color: #3a2e14;
      backface-visibility: hidden;
      background: radial-gradient(circle at 30% 25%, #f8eecf, #e9d8ae 65%, #d6ba73);
      text-shadow: 0 1px 0 rgba(255,255,255,.7), 0 2px 8px rgba(0,0,0,.15);
    }
    .face svg{ width: 60%; height: auto; opacity: .9; }

    .back{ transform: rotateY(180deg); }

    @keyframes flip{
      0%{ transform: rotateY(0deg) rotateZ(0deg); }
      50%{ transform: rotateY(180deg) rotateZ(10deg); }
      100%{ transform: rotateY(360deg) rotateZ(0deg); }
    }

    .overlay-text{
      color: #fff; font-weight: 800; letter-spacing: .5px; text-shadow: 0 2px 8px rgba(0,0,0,.55);
      font-size: clamp(16px, 4vw, 22px);
    }

    /* Accessibility: reduce motion */
    @media (prefers-reduced-motion: reduce){
      .coin{ animation: none; }
      .btn, .overlay{ transition: none; }
    }

    /* Responsive layout */
    @media (max-width: 900px){
      .players{ grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 520px){
      .controls{ grid-template-columns: 1fr; }
      .players{ grid-template-columns: 1fr; }
    }

    /* Dev test area */
    details.dev{
      background: rgba(255,255,255,.55);
      border: 2px dashed rgba(0,0,0,.12);
      border-radius: var(--radius);
      padding: 10px 14px;
      box-shadow: var(--shadow);
    }
    .test-log{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size: 12px; white-space: pre-wrap; }

    /* Visually hidden for screen readers */
    .sr-only{ position: absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand" role="banner" aria-label="The Goblin Coin Flipper">
        <!-- Simple inline SVG goblin -->
        <svg class="goblin-icon" viewBox="0 0 128 128" aria-hidden="true">
          <defs>
            <linearGradient id="g1" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0%" stop-color="#7fbf4d"/>
              <stop offset="100%" stop-color="#3e7a35"/>
            </linearGradient>
          </defs>
          <g fill="url(#g1)" stroke="#183c14" stroke-width="4" stroke-linecap="round" stroke-linejoin="round">
            <path d="M64 18c-22 0-40 18-40 40s18 40 40 40 40-18 40-40S86 18 64 18Z"/>
            <path d="M20 58C10 56 6 46 6 36c14 2 24 14 26 24M108 58c10-2 14-12 14-22-14 2-24 14-26 24"/>
            <circle cx="46" cy="60" r="6" fill="#1c1b1a"/>
            <circle cx="82" cy="60" r="6" fill="#1c1b1a"/>
            <path d="M48 84c10 6 22 6 32 0" fill="none"/>
          </g>
        </svg>
        <h1>The Goblin Coin Flipper</h1>
      </div>
    </header>

    <form class="controls" id="controls" autocomplete="off">
      <div class="field">
        <label for="times">How many flips per player?</label>
        <input id="times" name="times" type="number" inputmode="numeric" min="1" max="1000" step="1" placeholder="e.g., 7" required aria-describedby="hint" />
        <div id="hint" class="meta">Enter a positive integer (max 1,000).</div>
      </div>
      <button class="btn" id="flipBtn" type="submit" aria-live="polite">Flip for the Horde!</button>
    </form>

    <section class="players" aria-label="Results for 4 players" id="players">
      <!-- Player cards generated by JS -->
    </section>

    <!-- Developer self-tests (non-intrusive) -->
    <details class="dev">
      <summary><strong>Developer Self‑Test</strong> — verify RNG chunking & invariants</summary>
      <div style="display:grid; gap:8px; align-items:start; grid-template-columns: 1fr auto;">
        <div class="test-log" id="testLog" aria-live="polite"></div>
        <button id="runTests" class="btn" type="button">Run Self‑Test</button>
      </div>
    </details>

    <div id="live" class="sr-only" aria-live="polite"></div>
  </div>

  <!-- Overlay with coin animation -->
  <div class="overlay" id="overlay" aria-hidden="true" aria-modal="true" role="dialog">
    <div class="coin-wrap">
      <div class="coin" aria-hidden="true">
        <div class="face front" aria-hidden="true" title="Heads">
          <!-- Goblin face for heads -->
          <svg viewBox="0 0 128 128" aria-hidden="true">
            <g fill="#6ca64d" stroke="#2a4d1f" stroke-width="5" stroke-linecap="round" stroke-linejoin="round">
              <path d="M64 20c-20 0-36 16-36 36s16 36 36 36 36-16 36-36S84 20 64 20Z"/>
              <circle cx="50" cy="60" r="6" fill="#1c1b1a"/>
              <circle cx="78" cy="60" r="6" fill="#1c1b1a"/>
              <path d="M48 80c10 6 22 6 32 0" fill="none"/>
            </g>
          </svg>
        </div>
        <div class="face back" aria-hidden="true" title="Tails">
          <!-- Stylized coin tail glyph -->
          <svg viewBox="0 0 128 128" aria-hidden="true">
            <g fill="#c9b071" stroke="#7c6a38" stroke-width="6" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="64" cy="64" r="40"/>
              <path d="M64 36c10 0 20 8 20 20s-10 20-20 20-20 8-20 20" fill="none"/>
            </g>
          </svg>
        </div>
      </div>
      <div class="overlay-text">Goblins are flipping the coins…</div>
    </div>
  </div>

  <script>
    "use strict";
    (function(){
      /** Constants */
      const PLAYER_COUNT = 4;
      const ANIMATION_MS = 2000; // suspense delay
      const MAX_ROLLS = 1000; // cap to keep memory reasonable

      /** DOM elements */
      const playersEl = document.getElementById('players');
      const formEl = document.getElementById('controls');
      const timesInput = document.getElementById('times');
      const flipBtn = document.getElementById('flipBtn');
      const overlay = document.getElementById('overlay');
      const live = document.getElementById('live');
      const testLog = document.getElementById('testLog');
      const runTestsBtn = document.getElementById('runTests');

      /** Render player cards once */
      const state = { locked:false };

      function createPlayerCard(i){
        const card = document.createElement('article');
        card.className = 'card';
        card.setAttribute('aria-label', `Player ${i+1} result`);

        const title = document.createElement('h2');
        title.textContent = `Player ${i+1}`;
        card.appendChild(title);

        const results = document.createElement('div');
        results.className = 'results';

        const heads = document.createElement('div');
        heads.className = 'pill heads';
        heads.innerHTML = '<span class="dot" aria-hidden="true"></span><span>Heads: <strong>0</strong></span>';
        heads.setAttribute('data-kind','heads');

        const tails = document.createElement('div');
        tails.className = 'pill tails';
        tails.innerHTML = '<span class="dot" aria-hidden="true"></span><span>Tails: <strong>0</strong></span>';
        tails.setAttribute('data-kind','tails');

        results.appendChild(heads);
        results.appendChild(tails);
        card.appendChild(results);

        const meta = document.createElement('div');
        meta.className = 'meta';
        //meta.innerHTML = 'Last flip: <span data-last="-">—</span>';
        card.appendChild(meta);

        playersEl.appendChild(card);
      }

      for(let i=0;i<PLAYER_COUNT;i++) createPlayerCard(i);

      /** Utils */
      function isPositiveInteger(value){
        return Number.isInteger(value) && value > 0;
      }

      // Fast fair coin flips using cryptographic RNG with safe chunking.
      function flipNTimes(n){
        const heads = countHeads(n);
        const tails = n - heads;
        return { heads, tails };
      }

      /**
       * Count heads using crypto.getRandomValues with a conservative per-call limit.
       * Browsers enforce a max of 65536 BYTES per call. For Uint32Array, that's 16384 elements.
       * We compute the limit generically to be safe across engines.
       */
      function countHeads(n){
        // Determine safe chunk size in elements for Uint32Array
        const MAX_BYTES_PER_CALL = 65536; // spec/browser limit
        const ELEM_SIZE = Uint32Array.BYTES_PER_ELEMENT; // 4
        const CHUNK = Math.max(1, Math.floor(MAX_BYTES_PER_CALL / ELEM_SIZE)); // 16384

        let heads = 0;
        let remaining = n;
        // Prefer crypto RNG; fallback to Math.random if unavailable
        const hasCrypto = typeof window !== 'undefined' && window.crypto && typeof window.crypto.getRandomValues === 'function';

        while(remaining > 0){
          const size = Math.min(remaining, CHUNK);
          if(hasCrypto){
            const buf = new Uint32Array(size);
            // This call will not exceed byte quota due to CHUNK
            window.crypto.getRandomValues(buf);
            for(let i=0;i<size;i++) heads += (buf[i] & 1);
          } else {
            // Fallback (non-crypto). Maintains correctness, not cryptographic strength.
            for(let i=0;i<size;i++) heads += (Math.random() < 0.5 ? 1 : 0);
          }
          remaining -= size;
        }
        return heads;
      }

      function lockUI(){
        state.locked = true;
        flipBtn.setAttribute('disabled','');
        timesInput.setAttribute('disabled','');
        overlay.classList.add('show');
        overlay.setAttribute('aria-hidden','false');
        formEl.setAttribute('aria-busy','true');
      }

      function unlockUI(){
        state.locked = false;
        flipBtn.removeAttribute('disabled');
        timesInput.removeAttribute('disabled');
        overlay.classList.remove('show');
        overlay.setAttribute('aria-hidden','true');
        formEl.removeAttribute('aria-busy');
      }

      function updateResults(all){
        // all: Array<{heads, tails}>
        const cards = playersEl.querySelectorAll('.card');
        all.forEach((res, idx)=>{
          const card = cards[idx];
          const headsEl = card.querySelector('[data-kind="heads"] strong');
          const tailsEl = card.querySelector('[data-kind="tails"] strong');
          headsEl.textContent = String(res.heads);
          tailsEl.textContent = String(res.tails);
          //card.querySelector('[data-last]').textContent = new Date().toLocaleTimeString();
        });
        if(all && all.length){
          const flips = all[0].heads + all[0].tails;
          live.textContent = `Flip complete. Each player flipped ${flips} times.`;
        }
      }

      // Handle form submit (single button)
      formEl.addEventListener('submit', (e)=>{
        e.preventDefault();
        if(state.locked) return; // guard

        const times = Math.trunc(Number(timesInput.value));
        if(!isFinite(times) || !isPositiveInteger(times)){
          timesInput.focus();
          timesInput.setCustomValidity('Please enter a positive integer.');
          timesInput.reportValidity();
          return;
        }
        if(times > MAX_ROLLS){
          timesInput.focus();
          timesInput.setCustomValidity(`Please enter ${MAX_ROLLS.toLocaleString()} or fewer flips.`);
          timesInput.reportValidity();
          return;
        }
        timesInput.setCustomValidity('');

        lockUI();

        // Compute results during the suspense animation to avoid extra waiting
        const results = Array.from({length: PLAYER_COUNT}, () => flipNTimes(times));

        // Delay revealing results
        window.setTimeout(()=>{
          updateResults(results);
          unlockUI();
        }, ANIMATION_MS);
      });

      // Initialize defaults for convenience
      timesInput.value = 7;

      // ----------------------
      // Developer Self‑Tests
      // ----------------------
      function assert(condition, message){
        if(!condition){ throw new Error(message); }
      }

      function runSelfTests(){
        const cases = [1, 10, 1234, 16384, 16385, 32768, 65536];
        const out = [];
        out.push(`Running ${cases.length} cases...`);
        for(const n of cases){
          const {heads, tails} = flipNTimes(n);
          assert(Number.isInteger(heads) && Number.isInteger(tails), 'Counts must be integers');
          assert(heads >= 0 && tails >= 0, 'Counts must be non-negative');
          assert(heads + tails === n, `Sum mismatch for n=${n}`);
          out.push(`✔ n=${n.toLocaleString()} → heads=${heads}, tails=${tails}`);
        }
        testLog.textContent = out.join("\n");
      }

      if(runTestsBtn){
        runTestsBtn.addEventListener('click', ()=>{
          try{
            runSelfTests();
          }catch(err){
            testLog.textContent = `Self‑test failed: ${err.message}`;
          }
        });
      }
    })();
  </script>
</body>
</html>
